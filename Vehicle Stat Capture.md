# 车辆状态捕捉以及生成账单的系统过程

车辆状态捕捉，日志记录，账单生成以及日志每日的修正清理工作均由服务端后台不同 worker 进程所控制

## 车辆状态捕捉的方式

为了避免事件遗漏，系统采取被动与主动结合的方式进行事件信号的获取。这两种方式可以做到有效的互补。

### 被动响应

以publish/subscribed 的形式，通过注册一系列的 worker 进程分别响应不同的摄像头服务事件来被动的捕捉驶入、驶出等相关信号。

### 主动扫描

通过一系列work进程定时（可设定）扫描所有摄像头，以获取所有车辆当前的状态。

## 停车场当前状态check-in/check-out

系统初始化时根据车位的定价标准查询并设定主动扫描的开始与结束计费的时间点。可以设置提前于 check-in 和晚于 check-out 10分钟的时间（无需精确，只是为了不晚于计费时间点）。

### check-in

每日开始计费前10分钟，扫描并记录停车位中的车辆停车状态信息，作为一天的开始状态。

### check-out

每日结束计费10分钟之后，扫描并记录停车位中的车辆停车状态信息，作为一天的最后状态的更新的处理点。

## 账单生成

由一个账单生成的worker来处理账单的生成，并且账单处理通过5分钟的间隔执行，每次只针对于一辆车在一天内同一停车位的连续状态进行识别。为了避免状态的错误识别，只处理30分钟之前完成过 驶出 状态的车辆信息。
每天在开始计费后 50 分钟 开始执行，结束计费50分钟后作为左后一次执行时间。

## 数据清理

每天凌晨针对前一天的所有数据进行数据监测，整理和清理，防止脏数据的行程。

1. 车辆只有驶出记录无驶入记录，清理掉日志记录
2. 车辆只有驶入记录但无驶出记录，可以根据最后一次车辆在停车位中的状态来作为驶出记录生成账单
